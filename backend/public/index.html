<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-wallet text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Financial Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500" id="lastUpdate">Last update: --</span>
                    <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Balance Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm">Total Pemasukan</p>
                        <p class="text-3xl font-bold" id="totalIncome">Rp 0</p>
                    </div>
                    <i class="fas fa-arrow-up text-4xl text-green-200"></i>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-xl p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm">Total Pengeluaran</p>
                        <p class="text-3xl font-bold" id="totalExpense">Rp 0</p>
                    </div>
                    <i class="fas fa-arrow-down text-4xl text-red-200"></i>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">Saldo</p>
                        <p class="text-3xl font-bold" id="balance">Rp 0</p>
                    </div>
                    <i class="fas fa-chart-line text-4xl text-blue-200"></i>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Transaction Form -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-plus text-green-600 mr-2"></i>Tambah Transaksi
                    </h3>
                    <form id="transactionForm" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <select id="transactionType" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="expense">Pengeluaran</option>
                                <option value="income">Pemasukan</option>
                            </select>
                            <input type="number" id="transactionAmount" placeholder="Jumlah" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <select id="transactionCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Pengeluaran">Pengeluaran</option>
                            <option value="Makan">Makan</option>
                            <option value="Transport">Transport</option>
                            <option value="Tagihan">Tagihan</option>
                            <option value="Belanja">Belanja</option>
                        </select>
                        <input type="text" id="transactionDescription" placeholder="Deskripsi transaksi" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Simpan Transaksi
                        </button>
                    </form>
                </div>

                <!-- Period Filter -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold text-gray-900 mb-3">
                        <i class="fas fa-filter text-blue-600 mr-2"></i>Filter Laporan
                    </h3>
                    <div class="space-y-3">
                        <select id="periodFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="day">Hari Ini</option>
                            <option value="month" selected>Bulan Ini</option>
                            <option value="year">Tahun Ini</option>
                        </select>
                        <select id="categoryFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Semua Kategori</option>
                        </select>
                        <button onclick="filterTransactions()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>Filter Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Trend Keuangan</h3>
                <!-- <canvas id="trendChart" width="400" height="200" style="height:300px"></canvas> -->
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Breakdown Kategori</h3>
                <canvas id="categoryChart" width="400" height="200" style="height:300px"></canvas>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Transaksi Terbaru</h2>
                    <span class="text-sm text-gray-500" id="transactionCount">0 transaksi</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 text-center">
            <i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
            <p class="text-gray-700">Loading...</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <span id="notificationText"></span>
    </div>

    <script>
        // Global variables
        let transactions = [];
        let trendChart = null;
        let categoryChart = null;

        // API Base URL - Update this to match your backend server
        const API_BASE = '/api'; // Assuming you'll create an Express API server

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            
            notificationText.textContent = message;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 3000);
        }

        function showLoading(show = true) {
            const modal = document.getElementById('loadingModal');
            modal.style.display = show ? 'flex' : 'none';
        }

        // Real API functions
        async function fetchTransactions(period = 'month', category = '') {
            showLoading(true);
            
            try {
                const params = new URLSearchParams({
                    period,
                    userId: 1 // Default user for web interface
                });
                
                if (category) {
                    params.append('category', category);
                }
                
                const response = await fetch(`${API_BASE}/transactions?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching transactions:', error);
                showNotification('Gagal memuat data transaksi', 'error');
                return [];
            } finally {
                showLoading(false);
            }
        }

        async function fetchSummary(period = 'month') {
            try {
                const params = new URLSearchParams({
                    period,
                    userId: 1
                });
                
                const response = await fetch(`${API_BASE}/summary?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error fetching summary:', error);
                return { income: 0, expense: 0, balance: 0 };
            }
        }

        async function addTransaction(transactionData) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...transactionData,
                        userId: 1
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to add transaction');
                }
                
                const newTransaction = await response.json();
                showNotification('Transaksi berhasil ditambahkan!');
                return newTransaction;
            } catch (error) {
                console.error('Error adding transaction:', error);
                showNotification(error.message || 'Gagal menambahkan transaksi', 'error');
                return null;
            } finally {
                showLoading(false);
            }
        }

        async function deleteTransaction(id) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/transactions/${id}?userId=1`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete transaction');
                }
                
                showNotification('Transaksi berhasil dihapus!');
                return true;
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showNotification(error.message || 'Gagal menghapus transaksi', 'error');
                return false;
            } finally {
                showLoading(false);
            }
        }

        // Data Processing
        function calculateSummary(transactions) {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            return {
                income,
                expense,
                balance: income - expense
            };
        }

        function updateSummaryCards(summary) {
            document.getElementById('totalIncome').textContent = formatCurrency(summary.income);
            document.getElementById('totalExpense').textContent = formatCurrency(summary.expense);
            document.getElementById('balance').textContent = formatCurrency(summary.balance);
            
            // Update balance card color based on positive/negative
            const balanceCard = document.getElementById('balance').closest('.bg-gradient-to-r');
            if (summary.balance >= 0) {
                balanceCard.className = 'bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white';
            } else {
                balanceCard.className = 'bg-gradient-to-r from-red-500 to-red-600 rounded-xl p-6 text-white';
            }
        }

        function populateTransactionsTable(transactions) {
            const tbody = document.getElementById('transactionsTable');
            document.getElementById('transactionCount').textContent = `${transactions.length} transaksi`;
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>Tidak ada transaksi</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = transactions.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${t.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${moment(t.date).format('DD/MM/YYYY')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                            t.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.category}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${t.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${
                        t.type === 'income' ? 'text-green-600' : 'text-red-600'
                    }">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="confirmDelete(${t.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateCategoryFilter(transactions) {
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = [...new Set(transactions.map(t => t.category))];
            
            // Clear existing options except "Semua Kategori"
            categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        function updateTransactionTypeCategory() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('transactionCategory');
            
            categorySelect.innerHTML = '';
            
            if (type === 'income') {
                ['Pemasukan', 'Gaji', 'Bonus', 'Freelance', 'Komisi'].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            } else {
                ['Pengeluaran', 'Makan', 'Transport', 'Tagihan', 'Belanja'].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Charts
        function createTrendChart(transactions) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }

            // Group transactions by date
            const dailyData = {};
            transactions.forEach(t => {
                const date = t.date;
                if (!dailyData[date]) {
                    dailyData[date] = { income: 0, expense: 0 };
                }
                dailyData[date][t.type] += t.amount;
            });

            const sortedDates = Object.keys(dailyData).sort();
            const incomeData = sortedDates.map(date => dailyData[date].income);
            const expenseData = sortedDates.map(date => dailyData[date].expense);
            const labels = sortedDates.map(date => moment(date).format('DD/MM'));

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function createCategoryChart(transactions) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            // Group expenses by category
            const expensesByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);
            const colors = ['#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#8B5CF6', '#EC4899'];

            if (labels.length === 0) {
                // Show empty state
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Tidak ada data pengeluaran', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Event Handlers
        async function refreshData() {
            const period = document.getElementById('periodFilter').value;
            const category = document.getElementById('categoryFilter').value;
            
            // Fetch both transactions and summary concurrently
            const [transactionsData, summaryData] = await Promise.all([
                fetchTransactions(period, category),
                fetchSummary(period)
            ]);
            
            transactions = transactionsData;
            
            // Use real summary data from API
            updateSummaryCards(summaryData);
            populateTransactionsTable(transactions);
            populateCategoryFilter(transactions);
            createTrendChart(transactions);
            createCategoryChart(transactions);
            
            document.getElementById('lastUpdate').textContent = `Last update: ${moment().format('DD/MM/YYYY HH:mm')}`;
        }

        async function filterTransactions() {
            await refreshData();
        }

        async function confirmDelete(id) {
            if (confirm('Yakin ingin menghapus transaksi ini?')) {
                const success = await deleteTransaction(id);
                if (success) {
                    await refreshData();
                }
            }
        }

        // Form submission
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                category: document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDescription').value
            };
            
            if (formData.amount <= 0) {
                showNotification('Jumlah harus lebih dari 0', 'error');
                return;
            }
            
            const newTransaction = await addTransaction(formData);
            if (newTransaction) {
                // Reset form
                document.getElementById('transactionForm').reset();
                await refreshData();
            }
        });

        // Update category options when transaction type changes
        document.getElementById('transactionType').addEventListener('change', updateTransactionTypeCategory);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateTransactionTypeCategory();
            await refreshData();
        });
    </script>
</body>
</html>